---

mindmap-plugin: basic

---

# 应用层协议

## Web 和 HTTP
- 简述
  - HTTP
    - 概念：应用层协议，Web 核心
    - 程序分类：客户机程序、服务器程序
    - 功能：规定了报文格式和交换报文的方式
    - 无状态协议：不保存客户机任何信息
    - 底层运输协议：TCP
    - 工作过程：创建 TCP 连接、交换报文（进程通过套接字访问 TCP）、关闭 TCP 连接
  - Web 概念
    - Web 页：若干对象组成
    - 对象：文件
    - URL：统一资源定位符，存放对象服务器主机名和对象的路径名
    - 浏览器：用户代理，HTTP 协议的客户机端
    - Web 服务器：存储 Web 对象，服务器端
- HTTP 连接
  - 三次握手
  - 分类
    - 持续
      - 一个TCP连接上可以传送多个 Web 对象
      - 多个请求响应对
      - 超时未使用，服务器关闭连接
      - 方式
        - 流水线
          - 客户机连续产生请求
          - 服务器连续发送相应对象
          - 节省 RTT 时延
        - 非流水线
          - 客户机只能在前一个响应接收到之后才能发出新的请求
          - 一个对象一个 RTT 时延
    - 非持续
      - 每个 TCP 连接上只传送一个 Web 对象
      - 一个请求响应对
      - 往返时延 RTT：从客户机请求基本HTML文件开始，到用户收到整个文件为止所花时间
      - 可同时打开多个连接
        - 并行
        - 串行
      - 缺点
        - 服务器负担重：每一个请求对象建立和维护一个新的连接
        - 每一个对象的传输时延长：包含两个RTT时延，一个用于TCP建立， 一个用于请求和接收对象
- HTTP 报文格式
  - 请求：请求行+首部行+实体主体
  - 响应：状态行+首部行+实体主体
    - 状态码
      - 200 OK
      - 301
      - 400
      - 404
      - 505
- Cookie
  - 前提：HTTP 服务无状态
  - 功能：服务器跟踪、识别用户
  - 工作过程：先 set，再用
  - 划分
    - 在响应报文有 cookie 首部行
    - 在请求报文有 cookie 首部行
    - 用户主机保留一个 cookie 由浏览器管理
    - Web 站点后端数据库保存 cookie
  - 用途
    - 鉴权
    - 会话状态
- Web 缓存
  - Web 请求目标
    - 起始服务器：对象最初存放并始终保持其拷贝的服务器
    - Web 缓存器：也叫代理服务器。**能够代替起始服务器来满足HTTP请求**的网络实体
      - 可以保存最近请求过对象的副本
      - 一般在中间件实现，也可在客户机或服务器
  - 使用
    - 用户行为：配置浏览器（配置代理）
    - 代理行为：对象在缓存就返回缓存，不在就请求原始服务器
    - 无论是否使用缓存，端系统间都使用 HTTP 协议通信
  - 优点：降低网络时延，减少响应时间
  - 条件 GET
    - 动机：缓存可能过时
    - 方法：请求时检查 Web 对象的最后修改时间，与本地缓存比对
      - 请求头
        - Web 服务器：`Last-modified: date1`
        - 缓存条件 GET 请求：`If-modified-since: date1`
      - 响应
        - 未被修改：`304 Not Modified`，实体为空

## 应用层协议原理
- 网络应用程序体系结构
  - 客户机/服务器
    - 服务器
      - 为多个客户机提供服务
      - 总是打开
      - 永久 IP
      - 可扩展为集群
    - 客户机
      - 向服务器发送请求
      - 无需总是打开
      - 动态 IP
      - 彼此之间不能直接通信
  - 对等 P2P
    - 无打开的服务器
    - 端系统直接通信
    - 间歇连接，动态 IP
  - 客户机/服务器与 P2P 的混合
    - 服务器用于追踪用户的 IP
- 网络进程通信
  - 进程：在主机上运行的程序
    - 不同主机间方法：网络交换报文
  - web 应用
    - 客户机进程
    - 服务器进程
    - P2P 的应用程序既是服务器进程又是客户机进程
  - 套接字
    - 概念：应用层与运输层之间的接口（应用程序接口 API），是可编程接口
    - 与进程关系：进程通过套接字在网络上收发报文
    - 套接字可以控制应用层的全部
    - 套接字几乎不能控制运输层
    - 套接字选择运输层协议
  - 进程寻址
    - 功能：确定主机、确定进程
    - 主机名称：IP 地址
    - 进程标识：端口号
    - 网络应用程序端口不能重复
  - 用户代理
    - 用户与网络应用程序之间的接口
    - 比如具体浏览器软件，电子邮件软件
- 协议
  - 进程间传递报文的格式和方式
  - 内容
    - 交换的报文类型
    - 报文类型的语法
    - 字段的语义
    - 进程何时、如何发送报文，如何响应
  - 分类
    - 公共领域协议：RFC 定义
    - 专用层协议：具体应用的自定义协议
- 服务
  - 应用程序间通信
    - 使用运输层协议提供的服务
    - 可靠数据传输：是否容忍数据丢失
    - 带宽要求
    - 超时限制
  - TCP
    - 不适合实施应用
    - 面向连接的服务
      - 建立连接：两个套接字之间建立 TCP 连接
      - 传输报文：全双工
      - 拆除连接
    - 可靠传输服务
      - 无差错
      - 按适当顺序
      - 无丢失和重复
    - 拥塞控制：控制发送速率
  - UDP
    - 无连接
    - 不可靠传输
    - 无拥塞控制
    - 无时延保证
    - 适用于实时应用

## FTP
- 运输层协议：基于 TCP
- 控制连接：在整个用户会话期间持续连接
  - 功能：用于在两主机间传输控制信息（如用户标识、口令等）
  - 端口：21
  - 内容：用户标识、指令、改变远程目录
- 数据连接：非持续连接
  - 功能：准确传输文件，传输完**一个文件**就关闭
  - 端口：20
- 与 HTTP 比较
  - FTP 带外传输（控制和数据传输分离），HTTP 带内传输
  - FTP 有状态，HTTP 无状态

## SMTP
- 用户代理：邮件阅读和写入
  - 向发送方邮件服务器报文队列发送邮件
  - 从邮箱中获取邮件
- 邮件服务器
  - 发送方、接收方
  - 报文队列：存储要发出的邮件报文
  - 邮箱：收到的邮件
- SMTP 协议
  - 功能
    - 从一个邮件服务器的报文队列发送邮件到另一个邮件服务器的邮箱
    - 从用户代理发送报文队列到发送方邮件服务器
  - 运输层协议：基于 TCP
  - 端口：25
  - 特性
    - 不使用中间邮件服务器，它们之间直连
    - 如果接收方的邮件服务器没有开机，该邮件仍保留在发送方邮件服务器上，并在以后进行再次传送。邮件不会在某个中间邮件服务器停留。
    - 有握手过程，需指明收发双方邮件地址
- 邮件访问协议
  - 从服务器获取邮件
  - 发送邮件都是 SMTP 协议（推协议），而取邮件是拉协议，使用邮件访问协议
  - 分类
    - POP3
    - IMAP
    - 基于 Web
- 报文格式：首部、主体（ASCII）
- 与 HTTP 异同
  - SMTP 是推协议（推送报文），HTTP 是拉协议（请求报文）
  - 都是持续连接、都传输文件

## DNS
- 运输层协议：UDP
- 端口：53
- 服务
  - 主机名到 IP 的转换
  - 流量分载：反向代理、DDNS
- 分布式、层次数据库
  - 根 DNS 服务器
  - 顶级域服务器：.com/.cn
  - 权威 DNS 服务器：amazon.com/qq.com
- DNS查询
	- 递归查询：客户端只发一次请求
	- 迭代查询：从根往下层迭代轮询

## P2P 文件共享

- 位于网络边缘的端系统（对等方peer）互相之间可以直接获取对象
- 特点
	- 直接在对等方间传输
	- 高度可扩展能力
	- 客户机/服务器模式：请求的peer是客户机，被选中的是服务器

## 套接字

- 功能：运行在不同机器上的进程彼此通过套接字传递报文来进行通信
	- 进程
	- 套接字：从进程推信息到 TCP 连接
	- TCP 连接
- TCP 套接字
	- 先建立 TCP 连接，再进行数据传输
	- 分类
		- 欢迎套接字：服务器程序的一个套接字，用于接收客户机程序的初始连接
		- 连接套接字
	- 过程
		- 三次握手：客户向欢迎套接字发起三次握手
		- 服务器创建一个新套接字（连接套接字）
		- 进行可靠数据传输
- UDP 套接字
	- 不用三次握手进行连接，是无连接服务
	- 以分组为单位传输，分组中含目的进程地址