# 指令系统

- 格式
	- 操作码+操作数 x n

## 寻址方式

- 数据寻址
	- 分类
		- 立即数寻址：操作数包含在指令中
		- 寄存器寻址：操作数包含在CPU内部寄存器中
		- 存储器寻址：操作数在内存数据区中
		- IO寻址：操作数在IO端口寄存器
	- 寄存器寻址：`MOV CL, DL`
		- 源和目的大小一致
		- 目的寄存器不能是代码段寄存器
		- 比存储器寻址快
		- 指令长度短
	- 立即数寻址：`MOV AX, 1A2BH`
	- 存储器寻址
		- `[]` 表示对存储器寻址
		- 物理地址 `PA`：`DS/SS x 10H + EA`
		- 直接指定段地址：如 `EA = ES: [DI]`，有效地址 = 段地址：偏移地址
		- 直接寻址：`MOV AX, [1000H]` 或 `MOV AX, VAR` 或 `MOV AX, [VAR]`
			- 指令中以逻辑地址（有效地址EA）表示操作数存放的位置
			- 这意味着CPU需要再用段地址（默认在DS）与其相加成物理地址
		- 间接寻址：`MOV AX, [SI]`
			- 偏移地址（EA）用SI、DI、BX（数据段），BP（堆栈段）这四个寄存器之一来指定
			- EA来自数据段（SI、DI、BX）则段地址来自DS，EA来自堆栈段（BP）则段地址来自SS
		- 相对寻址：`MOV AX, [BX + 1000H]` 或 `MOV AX, 1000H[BX]` 或 `MOV AX, [BX] + 1000H`
			- EA有两部分：存于寄存器中的、偏移量（符号数）
			- BX/BP/SI/DI可用
		- 基址加变址寻址： `MOV AL, [BP][SI]` 或 `MOV AL, [BP + SI]`
			- EA两部分：一部分在基址寄存器（BX或BP），一部分在变址寄存器（SI或DI）
			- 若EA含BP，则默认段寄存器SS，否则默认为DS
		- 相对基址加变址寻址：缝合一下
	- IO寻址
		- IO地址：接口电路中寄存器的编号（地址）
		- 端口直接寻址：`IN AL, 21H`，端口用立即数表示（0-255）
		- 端口间接寻址：`MOV DX, 120H\n OUT DX, AX`（端口地址大于FFH时）
- 指令寻址：确定下一条指令地址
	- 顺序寻址：IP自增
	- 跳转寻址：`JMP`
		- 段内转移
			- 段内直接寻址：`JMP SHORT OPR` 指令给出偏移量，新偏移地址 = IP+偏移量（8位：短转移，16位：近转移）
			- 段内间接寻址：`JMP WORD PTR OPR` 转移指令指定一个16位寄存器或存储单元中的内容作为转移地址
		- 段间转移
			- 段间直接寻址：`JMP FAR PTR OPR` 指令中给出目标的段基址（高字）和段内偏移地址（低字）
			- 段间间接寻址：`JMP DWORD PTR OPR` 指令中给出一个存储单元的地址，用该地址指向的两个相邻字（32位）的内容来作为CS、IP的内容

## 指令系统

- 有一坨FLAG寄存器的变化
- 数据传送指令
	- 通用：`MOV DST, SRC`
	- 堆栈：`PUSH SRC; POP DST`
		- push除IP，pop除CS都可写
		- 栈顶总满
		- 栈顶指针指向高地址，栈基址指向低地址（倒置的栈）
	- 地址
		- `LEA REG, SRC`：只取有效地址（偏移地址）（`MOV` 要加DS）
		- `LDS REG, SRC`：SRC指定的四个字节中，前两个（作为偏移地址）传到REG，后两个（作为段地址）传到DS
		- `LES REG, SRC`：前两个到REG，后两个到ES
	- 标志寄存器：`LAHF/SAHF`
	- 数据交换：`XCHG DST, SRC`，交换两个位置的内容
		- 都不允许是段寄存器、立即数和IP
		- 必须有一个是寄存器
		- 不影响标志位
	- 换码指令：`XLAT`，用于查表，作用 `AL<-[AL+BX]`
	- 输入输出指令：`IN/OUT DST, SRC`
- 算术运算（影响标志位SF/CF/ZF/AF/OF/PF）
	- 加法
		- 不带进位：`ADD DST, SRC`
		- 带进位：`ADC DST, SRC`，还要加上标志位CF
		- 自增：`INC DST`
	- 减法
		- 不带借位：`SUB DST, SRC`
		- 带借位：`SBB DST, SRC`，还要减去标志位CF
		- 自减：`DEC DST`
		- 取负：`NEG DST`，按位取反+1
		- 比较：`CMP DST, SRC`
			- 相等：Z=1 否则 0
			- 有符号数
			- 无符号数
	- 乘法：`IMUL/MUL SRC`
		- 8位：高位去AH，低位去AL
		- 16位：高位去DX，低位去AX
	- 除法：`IDIV/DIV SRC`
		- 8位操作数：商去 AL，余数去AH
		- 16位：商去AX，余数去DX
	- 符号扩展
		- 字节扩展成单字：`CBW`
		- 单字扩展成双字：`CBD`
	- BCD调整指令：把非BCD转成BCD（+6进位实现，与之前相同）（回忆压缩、非压缩BCD）
		- 压缩加法：`DAA`
		- 压缩减法：`DAS`
		- 非压缩加法：`AAA`
		- 非压缩减法：`AAS`
		- 非压缩乘法：`AAM`
		- 非压缩除法：`AAD`
- 逻辑运算
	- 基本（按位）：`AND/OR/XOR/TEST DST, SRC; NOT DST`
- 移位（感觉不如贴个图）`COMM DST, COUNT`
	- 逻辑移位：`SHL/SHR`，无符号
	- 算术移位：`SAL/SAR`，有符号
	- 小循环：`ROL/ROR`
	- 大循环：`RCL/RCR`
- 串操作