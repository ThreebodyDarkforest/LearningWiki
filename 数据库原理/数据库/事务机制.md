# 事务机制

- 解决：并发控制、故障处理
- 性质
	- 原子性：事务中的操作要么都不做，要么都做
	- 一致性：事务操作保持一致性
	- 隔离性：类似进程锁
	- 持久性：事务成功后，对数据库的改变是永久的
- 状态
	- 激活状态：事务执行时处于
	- 部分提交
	- 失败
	- 丢弃并回滚
	- 提交
- 调度
	- 串行调度
	- 并行调度
	- 可串行化：如果一个调度能够与某个串行调度等价，它就是“可串行化”的
	- 冲突：同时写，或写时读
	- 冲突可串行化：把一个调度S中的连续的不冲突命令调换位置后，可得到一个串行调度，那么这个调度S是“冲突可串行化”
		- 本来就有写冲突的调度无法串行化
- 并发问题
	- 丢失更新：操作被覆盖
	- 未提交依赖：操作有回滚，操作回滚前其中被修改的数据被其它操作读
	- 不一致分析：先读一次，被其它操作修改，再读一次出现不一致
- 解决冲突
	- 锁
		- 共享锁/S锁：只读锁，其它操作也可以上只读锁来读
		- 排他锁/X锁：读写锁，不允许其它任何同时操作上锁
	- 二段加锁协议
		- 最初，事务处于增长阶段，事务根据需要获得锁。一旦该事务释放了锁，它就进人了缩减阶段，此后，就不能再发出加锁请求
		- 问题：死锁、级联回滚
		- 变体：
			- 严格二段锁：每个X锁必须等到commit才释放
			- 强二段锁：所有锁都要commit才释放
	- 时间戳协议
		- 每个对象两个时间戳：读它的最迟的事务，写它的最迟的事务
		- 发出读和写的不同情况

## 恢复机制

- 基于日志的恢复
	- \<Ti Start\>：开始
	- \<Ti, X, V1, V2\>：写X，V1->V2
	- \<Ti commit\>：提交
- 撤销和重做
	- 撤销：产生新的日志项用于回退
	- 重做：从头开始再做一遍日志，不产生新项
- 检查点
	- \<chekpoint\>：把所有内存块写到磁盘